package internal_test

import (
	"bytes"
	"slices"
	"testing"

	"github.com/tp86/legimi-go/internal/protocol"
)

func TestRegisterResponseDecoding(t *testing.T) {
	input := []byte{
		0x11, 0x00, 0x00, 0x00, 0x00, 0x40, 0x10, 0x00, 0x00, 0x00, 0x01, 0x00, 0x06, 0x00, 0x08, 0x00,
		0x00, 0x00, 0x4e, 0x61, 0xbc, 0x00, 0x00, 0x00, 0x00, 0x00,
	}
	expected := protocol.Register{KindleId: 12345678}
	var resp protocol.Register

	err := protocol.Decode(bytes.NewBuffer(input), &resp)
	if err != nil {
		t.Fatalf("decoding error: %v", err)
	}
	if resp != expected {
		t.Errorf("register response decoding: expected %v, got %v", expected, resp)
	}
}

func TestSessionResponseDecoding(t *testing.T) {
	input := []byte{
		0x11, 0x00, 0x00, 0x00, 0x02, 0x40, 0x28, 0x00, 0x00, 0x00, 0x01, 0x00, 0x07, 0x00, 0x20, 0x00,
		0x00, 0x00, '1', '2', '3', '4', '5', '6', '7', '8', '9', '0', 'a', 'b', 'c', 'd',
		'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't',
		'u', 'v',
	}
	expected := protocol.Session{Id: "1234567890abcdefghijklmnopqrstuv"}
	var resp protocol.Session

	err := protocol.Decode(bytes.NewBuffer(input), &resp)
	if err != nil {
		t.Fatalf("decoding error: %v", err)
	}
	if resp != expected {
		t.Errorf("session response decoding: expected %v, got %v", expected, resp)
	}
}

func TestBookListResponseDecoding(t *testing.T) {
	input := []byte{
		0x11, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x72, 0x00, 0x00, 0x00, 0x01, 0x00, 0x07, 0x13, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x0a,
		0x00, 0x08, 0x00, 0x00, 0x00, 0x4e, 0x61, 0xbc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0b, 0x00, 0x0a,
		0x00, 0x00, 0x00, 'B', 'o', 'o', 'k', ' ', 't', 'i', 't', 'l', 'e', 0x00, 0x00, 0x06,
		0x00, 0x00, 0x00, 'A', 'u', 't', 'h', 'o', 'r', 0x0d, 0x00, 0x08, 0x00, 0x00, 0x00, 0x02,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1e, 0x00, 0x01, 0x00, 0x00, 0x00, 0xff, 0x22, 0x00,
		0x08, 0x00, 0x00, 0x00, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38,
	}
	expected := protocol.BookList{
		{Id: 12345678, Title: "Book title", Author: "Author", Version: 2, Downloaded: true, NextPage: "12345678"},
	}
	var resp protocol.BookList

	err := protocol.Decode(bytes.NewBuffer(input), &resp)
	if err != nil {
		t.Fatalf("decoding error: %v", err)
	}
	if !slices.Equal(resp, expected) {
		t.Errorf("book list response decoding: expected %v, got %v", expected, resp)
	}
}

func TestEmptyBookListDecoding(t *testing.T) {
	input := []byte{
		0x11, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00,
	}
	expected := protocol.BookList{}
	var resp protocol.BookList

	err := protocol.Decode(bytes.NewBuffer(input), &resp)
	if err != nil {
		t.Fatalf("decoding error: %v", err)
	}
	if !slices.Equal(resp, expected) {
		t.Errorf("empty book list response decoding: expected %v, got %v", expected, resp)
	}
}

func TestBookDownloadDetailsDecoding(t *testing.T) {
	input := []byte{
		0x11, 0x00, 0x00, 0x00, 0x18, 0x00, 0x41, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
		0x00, 0x00, 0x00, 0x04, 0x02, 0x00, 0x02, 0x00, 0x08, 0x00, 0x00, 0x00, 0x4e, 0x61, 0xbc, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x00, 0x00, 0x00, 'h', 't', 't', 'p', 's', ':',
		'/', '/', 'f', 'i', 'l', 'e', '.', 'm', 'o', 'b', 'i', 0x00, 0x00, 0x00, 0x00, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00,
	}
	expected := protocol.BookDownloadDetails{
		Url:  "https://file.mobi",
		Size: 12345678,
	}
	var resp protocol.BookDownloadDetails

	err := protocol.Decode(bytes.NewBuffer(input), &resp)
	if err != nil {
		t.Fatalf("decoding error: %v", err)
	}
	if resp != expected {
		t.Errorf("book list response decoding: expected %v, got %v", expected, resp)
	}
}
